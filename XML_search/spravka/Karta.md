# Карта проекта XML_search (обновлено 2024)

> **ВАЖНО: Назначение базы данных и функциональность проекта**
> - База данных `gis` является основной базой данных PostGIS, откуда бот должен запрашивать информацию
> - Проект специализируется на:
>   - Работе с XML файлами
>   - Работе с PRJ файлами
>   - SQL запросах к базе данных PostGIS
>   - Выводе необходимой информации пользователям через Telegram бота
> - Название проекта `XML_search` является условным и не отражает полный функционал
> - При настройке конфигурации необходимо использовать существующую базу данных `gis`
> - **Точка входа main.py** теперь использует только BotManager как основной управляющий класс. Путь к конфигу передаётся через переменную окружения `XML_SEARCH_CONFIG` или явно через параметр конструктора.
> - **BotManager** требует обязательный параметр `config_path` (путь к конфигу), который передаётся из main.py.
> - **Использование .env:** рекомендуется хранить все чувствительные данные (токены, пароли, пути к конфигам) в .env-файле и/или переменных окружения. Пример .env приведён ниже.
> - **Устаревший класс BotApplication удалён** — запуск event loop и run_polling теперь происходит только через BotManager.
> - Мы столкнулись с фундаментальной особенностью библиотеки python-telegram-bot v20+: метод run_polling() внутри себя всегда пытается управлять event loop через loop.run_until_complete, что несовместимо с уже активным event loop. Даже если вы запускаете через PowerShell или через cmd.exe, иногда event loop может быть уже активен из-за особенностей среды или плагинов IDE. Но библиотека python-telegram-bot v20+ не поддерживает работу внутри уже активного event loop (см. https://docs.python-telegram-bot.org/en/stable/telegram.ext.application.html#telegram.ext.Application.run_polling). Даже если вы используете только asyncio.run(main()), если event loop уже активен (редко, но бывает в IDE), будет ошибка.

> **ВАЖНО: Пример содержимого .env**
# Настройки базы данных
DB_NAME=gis
DB_USER=postgres
DB_PASSWORD=postgres
DB_HOST=localhost
DB_PORT=5432

# Настройки XML
XML_OUTPUT_DIR=output
XML_TEMP_DIR=temp
LOG_DIR=logs
MAX_FILE_SIZE=10485760

# Настройки логирования
LOG_LEVEL=INFO
HTTPS_LOG_LEVEL=WARNING

# Настройки кэширования
CACHE_ENABLED=True
CACHE_TTL=3600
CACHE_MAX_SIZE=1000

# Настройки многопоточности
MAX_WORKERS=4
CHUNK_SIZE=100

# Дополнительные настройки
DEBUG=False
XML_UPDATE_INTERVAL=3600

# Telegram
TELEGRAM_TOKEN=**********:******************
ADMIN_IDS=**********

# Пароль для доступа к боту
ACCESS_PASSWORD=123

# Прокси настройки (раскомментируйте и укажите свой прокси, если нужно)
# HTTPS_PROXY=socks5://user:pass@proxy.example.com:1080
# HTTPS_PROXY=http://proxy.example.com:8080

# Пул соединений
DB_MIN_CONNECTIONS=2
DB_MAX_CONNECTIONS=10
DB_CONNECTION_TIMEOUT=30.0
DB_IDLE_TIMEOUT=300.0
DB_HEALTH_CHECK_INTERVAL=60
> **ВАЖНО: Конец примера содержимого .env**

## 1. Актуальная структура проекта
```
.searh/
├── XML_search/               
│   ├── bot/                 # Модульная структура [✓]
│   │   ├── handlers/       # Обработчики команд [✓]
│   │   │   ├── base_handler.py    # Базовый обработчик [✓]
│   │   │   ├── start_handler.py   # Стартовый обработчик [✓]
│   │   │   ├── auth_handler.py    # Авторизация [✓]
│   │   │   ├── search_handler.py  # Поиск [✓]
│   │   │   ├── export_handler.py  # Экспорт [✓]
│   │   │   ├── help_handler.py    # Помощь [✓]
│   │   │   └── error_handler.py   # Обработка ошибок [✓]
│   │   ├── states.py      # Состояния бота [✓]
│   │   ├── config.py      # Конфигурация бота [✓]
│   │   ├── bot_manager.py # Менеджер запуска бота (требует config_path) [✓]
│   │   └── keyboards/     # Клавиатуры для Telegram [✓]
│   ├── enhanced/           # Улучшенные компоненты [✓]
│   │   ├── db_manager_enhanced.py  # Новый менеджер БД [✓]
│   │   ├── db_pool.py             # Пул соединений [✓]
│   │   ├── cache_manager.py       # Кэширование [✓]
│   │   ├── log_manager.py         # Логирование [✓]
│   │   ├── metrics_manager.py     # Метрики (новый класс) [✓]
│   │   ├── exceptions.py          # Исключения [✓]
│   │   └── export/                # Компоненты экспорта [✓]
│   │       ├── export_manager.py  # Менеджер экспорта [✓]
│   │       ├── exporters/         # Экспортеры [✓]
│   │       │   ├── base_exporter.py    # Базовый класс [✓]
│   │       │   ├── civil3d.py          # Civil 3D [✓]
│   │       │   ├── gmv20.py            # GMv20 [✓]
│   │       │   └── gmv25.py            # GMv25 [✓]
│   │       └── templates/         # Шаблоны [✓]
│   ├── config/             # Конфигурация [✓]
│   │   ├── database.json         # БД [✓]
│   │   └── export_config.json    # Экспорт [✓]
│   ├── main.py            # Точка входа (использует только BotManager, config_path через env/параметр) [✓]
│   └── requirements.txt   # Зависимости [✓]
└── logs/                  # Логи [✓]
```

## 2. Статус компонентов

### 2.1 Рабочие компоненты [✓]
- Базовая структура бота
- Система авторизации с защитой от брутфорса
- Асинхронный пул соединений PostgreSQL
- Система логирования
- Менеджер базы данных
- Система кэширования с TTL
- Базовые обработчики команд
- Система метрик (через MetricsManager)
- Базовая структура экспортеров

### 2.2 Требуют доработки [!]
- Реализация конкретных форматов экспорта
- Тесты компонентов
- Документация API
- Мониторинг и алертинг
- Оптимизация работы с БД

### 2.3 Устаревшие/Нерабочие компоненты [-]
- Старая система авторизации
- menu_handler.py (функционал распределен)
- db_manager.py (заменен на db_manager_enhanced.py)
- Старая система состояний
- Старые тесты
- MetricsCollector (заменён на MetricsManager)
- **BotApplication (удалён, запуск только через BotManager)**

## 3. Приоритетные задачи

### 3.1 Критические [!]
1. Обеспечить базовую работу бота
2. Реализовать минимальный функционал экспортеров
3. Настроить обработку ошибок
4. Оптимизировать работу с PostgreSQL в Docker-контейнере
5. Улучшение конфигурации базы данных:
   - Добавить секцию для управления пулом соединений (retries, backoff)
   - Настроить более детальные параметры для health check
   - Добавить конфигурацию для SSL соединения
   - Использовать переменные окружения для чувствительных данных и путей к конфигам

### 3.2 Важные [+]
1. Улучшить валидацию данных
2. Добавить тесты (unit, integration)
3. Улучшить документацию
4. Реализовать мониторинг БД и метрик

### 3.3 Желательные [~]
1. Оптимизация производительности
2. Расширение функционала экспортеров
3. Улучшение UI/UX
4. Реализация кэширования запросов
5. Оптимизация работы с Docker:
   - Создать отдельный docker-compose.yml для разработки и продакшена
   - Добавить healthcheck для PostgreSQL контейнера
   - Настроить volumes для персистентности данных
6. Улучшение обработки сигналов:
   - Реализовать более гибкую систему shutdown hooks
   - Добавить таймауты для graceful shutdown
   - Улучшить логирование процесса завершения
7. Мониторинг и метрики:
   - Интеграция с Prometheus для сбора метрик
   - Добавление Grafana дашбордов
   - Расширение системы алертинга

## 4. Текущие зависимости
- python-telegram-bot==20.7
- psycopg2-binary==2.9.9
- python-dotenv==1.0.0
- asyncpg==0.29.0
- aiohttp==3.9.1
- и другие (см. requirements.txt)

## 5. Улучшения для работы с PostgreSQL и Docker

### 5.1 Асинхронный пул соединений [✓]
- Автоматическое управление соединениями
- Ограничение максимального количества соединений
- Проверка здоровья соединений
- Автоматическое переподключение
- Использование переменных окружения для конфигурации и секретов

### 5.2 Оптимизация запросов [~]
- Подготовленные запросы
- Кэширование результатов
- Пакетная обработка
- Мониторинг производительности

### 5.3 Безопасность и DevOps [!]
- Защита от SQL-инъекций
- Шифрование чувствительных данных
- Логирование доступа
- Ограничение прав доступа
- Использование Docker best practices (healthcheck, volumes, env)

## 6. Требования к переменным окружения и конфигурации

> **ВАЖНО: Требования к конфигу**
> - Все параметры, подгружаемые из переменных окружения, должны приводиться к нужному типу (int, float, bool) в момент инициализации конфигурации.
> - Это требование распространяется на все конфиг-классы (DatabaseConfig, CacheManagerConfig, MetricsConfig, SearchConfig, LogManagerConfig, ExporterConfig, ExportConfig и др.), а не только на DatabaseConfig.

- Все параметры, подгружаемые из переменных окружения, должны приводиться к нужному типу (int, float, bool) в момент инициализации конфигурации.
- Для числовых и булевых параметров (например, DB_PORT, DB_MIN_CONNECTIONS, CACHE_ENABLED и др.) обязательно использовать явное приведение типов в коде (например, int(os.getenv('DB_PORT'))).
- В случае невозможности приведения типов или некорректного значения должна выбрасываться информативная ошибка конфигурации. 