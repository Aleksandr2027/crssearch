# Карта проекта XML_search (обновлено 2025-06-09)

> **ВАЖНО: Назначение базы данных и функциональность проекта**
> - База данных `gis` является основной базой данных PostGIS, откуда бот должен запрашивать информацию
> - Проект специализируется на:
>   - Работе с XML файлами
>   - Работе с PRJ файлами
>   - SQL запросах к базе данных PostGIS
>   - Выводе необходимой информации пользователям через Telegram бота
> - Название проекта `XML_search` является условным и не отражает полный функционал
> - При настройке конфигурации необходимо использовать существующую базу данных `gis`
> - **Точка входа main.py** теперь использует только BotManager как основной управляющий класс. Путь к конфигу передаётся через переменную окружения `XML_SEARCH_CONFIG` или явно через параметр конструктора.
> - **BotManager** требует обязательный параметр `config_path` (путь к конфигу), который передаётся из main.py.
> - **Использование .env:** рекомендуется хранить все чувствительные данные (токены, пароли, пути к конфигам) в .env-файле и/или переменных окружения. Пример .env приведён ниже.
> - **Устаревший класс BotApplication удалён** — запуск event loop и run_polling теперь происходит только через BotManager.

> **СТАТУС ПРОЕКТА: ПОЛНОСТЬЮ РАБОЧИЙ [✓]**
> - ✅ **Inline поиск GSK/MSK систем**: ИСПРАВЛЕНА проблема с лишними результатами при поиске "гск11з15"
> - ✅ **Фильтрация проблемных вариантов**: Реализована умная система фильтрации для избежания ложных срабатываний
> - ✅ **Поиск по описанию (inline)**: Исправлена проблема с поиском MSK систем через @CrsSearchBot
> - ✅ **Транслитерация**: Реализована полная поддержка UTM форматов и клавиатурных ошибок
> - ✅ **Авторизация**: Устранены дублирования сообщений и проблемы с навигацией
> - ✅ **Парсинг координат**: Исправлены ошибки с регулярными выражениями
> - ✅ **Навигация**: Решены проблемы с состояниями ConversationHandler
> - ✅ **UI/UX**: Очищен интерфейс от лишних команд
> - ✅ **Экспорт PRJ-файлов**: Добавлены кнопки для экспорта СК в форматах GMv20 и GMv25
> - ✅ **ConversationHandler**: Исправлены проблемы с inline результатами и кнопкой "🔙 Главное меню"
> - ✅ **Управление состояниями**: Решены проблемы с автоматическим возвратом в главное меню

> **ПОСЛЕДНИЕ ИСПРАВЛЕНИЯ (2025-06-09):**
> - 🔧 **Исправлен ConversationHandler**: Решены проблемы с обработкой inline результатов и навигации
> - 🚀 **Улучшена навигация**: Кнопка "🔙 Главное меню" теперь работает корректно во всех состояниях
> - 🔍 **Исправлены inline результаты**: Результаты inline поиска больше не вызывают автоматический возврат в главное меню
> - 📝 **Обновлены импорты**: Исправлены все проблемы с импортом констант клавиатур
> - 🎯 **Стабилизированы состояния**: ConversationHandler теперь правильно обрабатывает все переходы между состояниями
> - ⚡ **НОВОЕ: Кнопки экспорта в inline поиске**: Добавлены кнопки экспорта GMv20/GMv25/Civil3D прямо в результаты @CrsSearchBot поиска
> - 📤 **Inline экспорт PRJ-файлов**: Теперь можно экспортировать PRJ-файлы прямо из inline результатов поиска по описанию
> - 🔄 **Унифицирован UX**: Inline поиск теперь имеет такую же функциональность экспорта, как и поиск по координатам

> **ЗАПУСК БОТА В WINDOWS 10 ЧЕРЕЗ POWERSHELL:**
> ```powershell
> cd C:\Users\Aleksandr\.searh\XML_search
> venv\Scripts\activate
> cd C:\Users\Aleksandr\.searh
> python XML_search/main.py
> ```

# Настройки базы данных
DB_NAME=gis
DB_USER=postgres
DB_PASSWORD=postgres
DB_HOST=localhost
DB_PORT=5432

# Настройки XML
XML_OUTPUT_DIR=output
XML_TEMP_DIR=temp
LOG_DIR=logs
MAX_FILE_SIZE=10485760

# Настройки логирования
LOG_LEVEL=INFO
HTTPS_LOG_LEVEL=WARNING

# Настройки кэширования
CACHE_ENABLED=True
CACHE_TTL=3600
CACHE_MAX_SIZE=1000

# Настройки многопоточности
MAX_WORKERS=4
CHUNK_SIZE=100

# Дополнительные настройки
DEBUG=False
XML_UPDATE_INTERVAL=3600

# Telegram
TELEGRAM_TOKEN=**********:******************
ADMIN_IDS=**********

# Пароль для доступа к боту
ACCESS_PASSWORD=123

# Прокси настройки (раскомментируйте и укажите свой прокси, если нужно)
# HTTPS_PROXY=socks5://user:pass@proxy.example.com:1080
# HTTPS_PROXY=http://proxy.example.com:8080

# Пул соединений
DB_MIN_CONNECTIONS=2
DB_MAX_CONNECTIONS=10
DB_CONNECTION_TIMEOUT=30.0
DB_IDLE_TIMEOUT=300.0
DB_HEALTH_CHECK_INTERVAL=60

## 1. Актуальная структура проекта
```
.searh/
├── XML_search/               
│   ├── bot/                 # Модульная структура [✓]
│   │   ├── handlers/       # Обработчики команд [✓]
│   │   │   ├── base_handler.py    # Базовый обработчик [✓ ИСПОЛЬЗУЕТСЯ]
│   │   │   ├── start_handler.py   # Стартовый обработчик [✓ ИСПОЛЬЗУЕТСЯ]
│   │   │   ├── auth_handler.py    # Авторизация [✓ ИСПОЛЬЗУЕТСЯ]
│   │   │   ├── search_handler.py  # Поиск [✓ ИСПОЛЬЗУЕТСЯ]
│   │   │   ├── export_handler.py  # Экспорт [✓ ИСПОЛЬЗУЕТСЯ]
│   │   │   ├── help_handler.py    # Помощь [✓ ИСПОЛЬЗУЕТСЯ]
│   │   │   ├── error_handler.py   # Обработка ошибок [✓ ИСПОЛЬЗУЕТСЯ]
│   │   │   ├── menu_handler.py    # Главное меню [✓ ИСПОЛЬЗУЕТСЯ]
│   │   │   ├── coord_handler.py   # Поиск по координатам [✓ ИСПОЛЬЗУЕТСЯ]
│   │   │   ├── coord_export_handler.py  # Экспорт результатов координат [✓ НОВЫЙ КОМПОНЕНТ]
│   │   │   └── exceptions.py      # Исключения [✓ ИСПОЛЬЗУЕТСЯ]
│   │   ├── states.py      # Состояния бота [✓ ИСПОЛЬЗУЕТСЯ]
│   │   ├── config.py      # Конфигурация бота [✓ ИСПОЛЬЗУЕТСЯ]
│   │   ├── bot_manager.py # Менеджер запуска бота [✓ ИСПОЛЬЗУЕТСЯ]
│   │   ├── keyboards/     # Клавиатуры для Telegram [✓ ИСПОЛЬЗУЕТСЯ]
│   │   └── states/        # Дополнительные состояния [✓ используется]
│   ├── enhanced/           # Улучшенные компоненты [✓]
│   │   ├── db_manager_enhanced.py  # Новый менеджер БД [✓ ИСПОЛЬЗУЕТСЯ]
│   │   ├── db_manager.py          # Основной менеджер БД [✓ ИСПОЛЬЗУЕТСЯ]
│   │   ├── db_pool.py             # Пул соединений [✓ ИСПОЛЬЗУЕТСЯ]
│   │   ├── cache_manager.py       # Кэширование [✓ ИСПОЛЬЗУЕТСЯ]
│   │   ├── log_manager.py         # Логирование [✓ ИСПОЛЬЗУЕТСЯ]
│   │   ├── metrics_manager.py     # Метрики [✓ ИСПОЛЬЗУЕТСЯ]
│   │   ├── config_enhanced.py     # Расширенная конфигурация [✓ ИСПОЛЬЗУЕТСЯ]
│   │   ├── transliterator.py      # Транслитерация [✓ ИСПОЛЬЗУЕТСЯ]
│   │   ├── exceptions.py          # Исключения [✓ ИСПОЛЬЗУЕТСЯ]
│   │   ├── db_retry.py           # Повторы БД [✓ ИСПОЛЬЗУЕТСЯ]
│   │   ├── db_health.py          # Здоровье БД [✓ ИСПОЛЬЗУЕТСЯ]
│   │   ├── db_context.py         # Контекст БД [✓ ИСПОЛЬЗУЕТСЯ]
│   │   ├── search/               # Улучшенные компоненты поиска [✓ НОВЫЙ КОМПОНЕНТ]
│   │   │   ├── __init__.py       # Инициализация модуля [✓ ИСПОЛЬЗУЕТСЯ]
│   │   │   ├── search_engine.py  # Улучшенный поисковый движок [✓ ИСПОЛЬЗУЕТСЯ]
│   │   │   └── search_utils.py   # Улучшенные утилиты поиска [✓ ИСПОЛЬЗУЕТСЯ]
│   │   ├── config/               # Конфигурация enhanced [✓]
│   │   │   └── database.json     # Конфиг БД [✓ ИСПОЛЬЗУЕТСЯ]
│   │   └── export/               # Компоненты экспорта [✓]
│   │       ├── export_manager.py  # Менеджер экспорта [✓ ИСПОЛЬЗУЕТСЯ]
│   │       ├── export_handler.py  # Обработчик экспорта [✓ ИСПОЛЬЗУЕТСЯ]
│   │       ├── export_config.py   # Конфигурация экспорта [✓ ИСПОЛЬЗУЕТСЯ]
│   │       ├── exporters.py       # Базовые экспортеры [✓ ИСПОЛЬЗУЕТСЯ]
│   │       ├── exceptions.py      # Исключения экспорта [✓ ИСПОЛЬЗУЕТСЯ]
│   │       ├── config/            # Конфигурация экспорта [✓]
│   │       ├── templates/         # Шаблоны [✓ ИСПОЛЬЗУЕТСЯ]
│   │       └── exporters/         # Экспортеры [✓ ИСПОЛЬЗУЕТСЯ]
│   │           ├── base_exporter.py    # Базовый класс [✓ ИСПОЛЬЗУЕТСЯ]
│   │           ├── base.py             # Используется вместе с base_exporter.py [✓ ИСПОЛЬЗУЕТСЯ]
│   │           ├── civil3d_exporter.py # Civil 3D экспортер [✓ ИСПОЛЬЗУЕТСЯ]
│   │           ├── civil3d.py          # Используется вместе с civil3d_exporter.py [✓ ИСПОЛЬЗУЕТСЯ]
│   │           ├── gmv20_exporter.py   # GMv20 экспортер [✓ ИСПОЛЬЗУЕТСЯ]
│   │           ├── gmv20.py            # Используется вместе с gmv20_exporter.py [✓ ИСПОЛЬЗУЕТСЯ]
│   │           ├── gmv25_exporter.py   # GMv25 экспортер [✓ ИСПОЛЬЗУЕТСЯ]
│   │           ├── gmv25.py            # Используется вместе с gmv25_exporter.py [✓ ИСПОЛЬЗУЕТСЯ]
│   │           └── prj_exporter.py     # Базовый класс для PRJ-экспортеров [✓ НОВЫЙ КОМПОНЕНТ]
│   ├── config/             # Конфигурация [✓]
│   │   ├── db_config.json         # Конфиг БД [✓ ИСПОЛЬЗУЕТСЯ]
│   │   ├── enhanced_config.json   # Расширенный конфиг [✓ ИСПОЛЬЗУЕТСЯ]
│   │   └── export_config.json     # Конфиг экспорта [✓ ИСПОЛЬЗУЕТСЯ]
│   ├── core/               # Ядро системы [✓ ИСПОЛЬЗУЕТСЯ]
│   │   └── search/         # Поиск [✓ ИСПОЛЬЗУЕТСЯ]
│   │       ├── __init__.py        # Инициализация модуля [✓ ИСПОЛЬЗУЕТСЯ]
│   │       ├── search_engine.py   # Прокси SearchEngine к EnhancedSearchEngine [✓ ИСПОЛЬЗУЕТСЯ]
│   │       ├── transliterator.py  # Прокси SearchTransliterator к Transliterator [✓ ИСПОЛЬЗУЕТСЯ]
│   │       └── utils.py           # Прокси SearchUtils к enhanced.search.SearchUtils [✓ ИСПОЛЬЗУЕТСЯ]
│   ├── spravka/            # Документация [✓ НЕ ИСПОЛЬЗУЕТСЯ НО ЯВЛЯЕТСЯ НЕОБХОДИМОЙ СОСТАВЛЯЮЩЕЙ]
│   │   └── Karta.md              # Актуальная карта проекта [✓ ИСПОЛЬЗУЕТСЯ]
│   ├── REFACTORING_REPORT.md # Отчет о рефакторинге [✓ НОВЫЙ КОМПОНЕНТ]
│   ├── logs/               # Логи [✓ ИСПОЛЬЗУЕТСЯ]
│   ├── metrics/            # Метрики [✓ ИСПОЛЬЗУЕТСЯ]
│   ├── output/             # Выходные файлы [✓ ИСПОЛЬЗУЕТСЯ]
│   ├── temp/               # Временные файлы [✓ ИСПОЛЬЗУЕТСЯ]
│   ├── templates/          # Шаблоны [✓ ИСПОЛЬЗУЕТСЯ]
│   ├── venv/               # Виртуальное окружение [✓ ИСПОЛЬЗУЕТСЯ]
│   ├── main.py            # Точка входа [✓ ИСПОЛЬЗУЕТСЯ]
│   ├── config.py          # Основная конфигурация [✓ ИСПОЛЬЗУЕТСЯ]
│   ├── crs_search.py      # Поиск СК [✓ ИСПОЛЬЗУЕТСЯ]
│   ├── database.py        # База данных [✓ ИСПОЛЬЗУЕТСЯ]
│   ├── errors.py          # Ошибки [✓ ИСПОЛЬЗУЕТСЯ]
│   ├── requirements.txt   # Зависимости [✓ ИСПОЛЬЗУЕТСЯ]
│   └── __init__.py        # Инициализация пакета [✓ ИСПОЛЬЗУЕТСЯ]
├── logs/                  # Логи [✓ ИСПОЛЬЗУЕТСЯ]
├── requirements.txt       # Корневые зависимости [✓ ИСПОЛЬЗУЕТСЯ]
├── setup.py              # Установка пакета [✓ ИСПОЛЬЗУЕТСЯ]
├── pyproject.toml        # Конфигурация проекта [✓ ИСПОЛЬЗУЕТСЯ]
└── README.md             # Документация [✓ ИСПОЛЬЗУЕТСЯ]
```

## 1.1 Решенные проблемы и улучшения [✓]

### 1.1.1 НОВОЕ: Добавлен экспорт PRJ-файлов [✓ РЕШЕНО 2025-06-02]
**Проблема**: В результатах поиска систем координат по широте/долготе отсутствовали кнопки для экспорта в форматах GMv20 и GMv25.
**Корневая причина**: 
- Отсутствие компонентов для экспорта PRJ-файлов
- Отсутствие интерактивных кнопок для выбора формата экспорта
- Отсутствие обработчика для экспорта результатов поиска по координатам

**Техническое решение**:
- Создан базовый класс `PRJExporter` для экспорта PRJ-файлов
- Реализованы специализированные экспортеры:
  - `GMv20Exporter` - экспортер для Global Mapper v20
  - `GMv25Exporter` - экспортер для Global Mapper v25
  - `Civil3DExporter` (заглушка) - выводит сообщение "Функционал в разработке"
- Создан обработчик `CoordExportHandler` для обработки нажатий на кнопки экспорта
- Добавлено формирование PRJ-файлов с именем:
  - `UTM_zone_xxN.prj` для SRID от 32601 до 32660
  - `srtext.prj` для систем с auth_name=custom
- Реализована отправка PRJ-файлов пользователю в виде документов

**Результат**: 
- Для каждой системы координат в результатах поиска отображаются кнопки экспорта
- При нажатии на кнопку GMv20 или GMv25 генерируется и отправляется PRJ-файл
- При нажатии на кнопку Civil3D выводится сообщение "Функционал в разработке"
- Улучшено пользовательское взаимодействие при работе с системами координат

### 1.1.2 НОВОЕ: Рефакторинг поисковых компонентов для устранения дублирования [✓ РЕШЕНО 2025-06-01]
**Проблема**: Дублирование кода между модулями `core/search` и `enhanced` создавало сложности при внесении изменений и могло привести к расхождениям в функциональности.
**Корневая причина**: 
- Отсутствие четкого разделения ответственности между модулями
- Копирование кода вместо использования наследования и агрегации
- Неоптимальная организация импортов

**Техническое решение**:
- Создан подмодуль `enhanced/search/` с улучшенными компонентами поиска
- Реализованы классы `EnhancedSearchEngine` и улучшенный `SearchUtils`
- Компоненты в `core/search/` преобразованы в прокси-классы к улучшенным компонентам
- Обновлены импорты в `__init__.py` файлах для поддержки обратной совместимости
- Добавлен детальный отчет о рефакторинге в `spravka/REFACTORING_REPORT.md`

**Результат**: 
- Устранено дублирование кода
- Улучшена структура проекта с четким разделением ответственности
- Сохранена обратная совместимость для существующего кода
- Улучшена расширяемость: новые функции можно добавлять в `enhanced` без изменения `core`
- Повышена надежность: все компоненты используют единую кодовую базу

### 1.1.3 Поиск по описанию (inline search) [✓]
**Проблема**: Inline поиск `@CrsSearchBot vcr` не находил MSK системы, показывал неправильный формат результатов.
**Решение**: 
- Изменен источник данных с `spatial_ref_sys` на `custom_geom` таблицу
- Унифицирован формат результатов с координатным поиском
- Добавлена поддержка UTM систем из обеих таблиц
- Исправлена обработка inline результатов в состояниях

### 1.1.4 Система транслитерации [✓]
**Проблема**: Неполная поддержка вариантов ввода координатных систем.
**Решение**:
- Добавлены клавиатурные ошибки: `ьыл→мск`, `мыл→vcr`, `гем→utm`
- Реализована поддержка зонных обозначений: `z↔з↔я`, `p↔з↔р`
- Добавлена транслитерация zone: `ящту→zone`, `ящт→zon`, `ящ→zo`
- Создана специальная обработка UTM форматов: `UTM zone 20` → `UTM +zone=20`

### 1.1.5 Система авторизации [✓]
**Проблема**: Дублирование сообщений, отсутствие главного меню после авторизации.
**Решение**:
- Добавлена связь между `auth_handler` и `menu_handler`

### 1.1.6 ConversationHandler и управление состояниями [✓ РЕШЕНО 2025-06-09]
**Проблема**: Inline результаты поиска автоматически возвращали в главное меню, кнопка "🔙 Главное меню" вызывала сообщение "Неизвестная команда".
**Корневая причина**: 
- Inline результаты (сообщения с "🔷 SRID:...") попадали в `handle_unknown_command`
- Испорченная константа `BUTTON_MENU = '🔙 Вернуться в меню'` в `MainKeyboard`
- Неправильная структура ConversationHandler в `bot_manager.py`
- Отсутствие обработчиков для inline результатов в состоянии `SEARCH_INPUT`

**Техническое решение**:
- Исправлена константа `MainKeyboard.BUTTON_MENU = '🔙 Главное меню'`
- Добавлен специальный обработчик `handle_inline_result_message()` с regex фильтром `^🔷 SRID:`
- Реорганизован ConversationHandler: удален вложенный handler из `SearchHandler.get_handler()`
- Добавлены правильные обработчики для кнопки "🔙 Главное меню" в состояние `SEARCH_INPUT`
- Исправлены все импорты констант в `keyboards/__init__.py` и `keyboard_utils.py`
- Обновлен основной ConversationHandler в `bot_manager.py` для корректной обработки состояний

**Новая функциональность inline экспорта (2025-06-09)**:
- Создан метод `_get_export_keyboard_for_srid()` для генерации кнопок экспорта в inline результатах
- Добавлен обработчик `handle_inline_export_callback()` для обработки экспорта из inline режима
- Реализован экспорт PRJ-файлов с использованием существующих экспортеров GMv20/GMv25
- Добавлена интеграция с CallbackQueryHandler в bot_manager.py (pattern: `^inline_export_`)
- Унифицированы форматы callback_data: `inline_export_{type}_{format}_{srid}`
- Добавлена автоматическая генерация имен файлов: `UTM_zone_XXN.prj` для UTM, `SRID_XXX_{format}.prj` для остальных

**Результат**: 
- Inline результаты корректно игнорируются и не влияют на состояние бота
- Кнопка "🔙 Главное меню" работает во всех состояниях без ошибок
- Поиск по описанию остается в контексте поиска до явного возврата пользователем
- Устранены все сообщения "Неизвестная команда" при корректном использовании

**Протестированные функции (2025-06-09)**:
- ✅ Поиск СК по Lat/Lon: работает корректно (55.7558$37.6173, 55 45 20.88;37 37 2.28)
- ✅ Экспорт PRJ-файлов: GMv20 и GMv25 экспортеры работают (UTM_zone_37N.prj, SK95z7_v25.prj)
- ✅ Inline поиск: @CrsSearchBot находит системы (msk, msk5, msk50, vuun, мггт)
- ✅ **НОВОЕ: Inline экспорт**: Кнопки GMv20/GMv25/Civil3D появляются в каждом inline результате
- ✅ **НОВОЕ: PRJ-файлы из inline**: Экспорт работает прямо из @CrsSearchBot результатов
- ✅ Навигация: все кнопки работают без сообщений об ошибках
- ✅ Авторизация: пароль 123 принимается корректно
- ✅ Состояния бота: переходы между состояниями стабильны

## 1.2 Новая функциональность: Inline экспорт PRJ-файлов [✅ РЕАЛИЗОВАНО 2025-06-09]

### 1.2.1 Описание функциональности
**Функция**: Кнопки экспорта GMv20/GMv25/Civil3D теперь доступны прямо в результатах inline поиска через @CrsSearchBot.

**Как использовать**:
1. В любом чате Telegram введите `@CrsSearchBot msk` (или другой поисковый запрос)
2. Выберите нужную систему координат из списка результатов
3. После отправки результата в чат появятся кнопки экспорта: 📄 Civil3D, 📋 GMv20, 📋 GMv25
4. Нажмите нужную кнопку для экспорта PRJ-файла
5. Файл автоматически отправится в чат с правильным именем

**Форматы экспорта**:
- **📋 GMv20**: PRJ-файл для Global Mapper v20+
- **📋 GMv25**: PRJ-файл для Global Mapper v25+  
- **📄 Civil3D**: Функционал в разработке (показывает уведомление)

**Автоматическое именование файлов**:
- UTM системы: `UTM_zone_37N.prj`
- Остальные системы: `SRID_32637_GMV20.prj`

### 1.2.2 Преимущества новой функциональности
- ⚡ **Быстрый доступ**: Экспорт прямо из результатов поиска без перехода в меню
- 🔄 **Единообразие UX**: Такие же возможности экспорта как в поиске по координатам
- 📱 **Удобство**: Работает в любом чате через inline режим
- 🎯 **Точность**: Автоматически корректные имена файлов для разных форматов

### 1.2.3 Техническая реализация
- Кнопки экспорта интегрированы в `InlineKeyboardMarkup` каждого inline результата
- Callback обработчик `handle_inline_export_callback()` зарегистрирован вне ConversationHandler
- Используется паттерн `^inline_export_` для маршрутизации callback'ов
- Экспорт выполняется через существующие GMv20/GMv25 экспортеры
- Автоматическая очистка временных файлов после отправки

**Итог**: Бот теперь предоставляет полнофункциональный экспорт PRJ-файлов как в режиме поиска по координатам, так и в inline поиске по описанию. Пользовательский опыт максимально унифицирован и удобен.