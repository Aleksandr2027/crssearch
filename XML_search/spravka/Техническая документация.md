# Техническая документация проекта XML_search

## 1. Введение

**XML_search** — асинхронный Telegram-бот для поиска и экспорта систем координат с интеграцией с PostgreSQL/PostGIS, поддержкой работы в Docker, расширенной системой метрик, кэширования, логирования и модульной архитектурой. Проект реализует современные best practices Python-разработки, DevOps и безопасности.

## 2. Обзор структуры проекта

- **XML_search/** — основной код проекта
  - **bot/** — обработчики команд, состояния, клавиатуры, утилиты, тесты
  - **enhanced/** — менеджеры БД, кэша, метрик, логирования, экспорт, шаблоны
  - **config/** — основные конфиги (БД, экспорт, расширенные параметры)
  - **spravka/** — документация, карта проекта, примеры .env
  - **tests/** — тесты (unit, integration)
  - **logs/** — логи
- **main.py** — точка входа, запуск BotManager
- **requirements.txt, pyproject.toml, setup.py** — зависимости и сборка

## 3. Описание файлов и модулей

### 3.1 Обработчики (bot/handlers)
- **base_handler.py** — базовый класс для всех обработчиков, реализует общие методы (БД, кэш, метрики, логирование, обработка ошибок)
- **menu_handler.py** — обработка главного меню, команд /start, /menu, /help
- **auth_handler.py** — авторизация пользователей, FSM для пароля, блокировка
- **search_handler.py** — поиск систем координат, FSM, пагинация, фильтры
- **export_handler.py** — экспорт в разные форматы, FSM, взаимодействие с ExportManager
- **coord_handler.py** — поиск по координатам, поддержка UTM, валидация
- **error_handler.py** — универсальный обработчик ошибок
- **start_handler.py** — обработка /start, инициализация сессии
- **exceptions.py** — пользовательские исключения для обработчиков

### 3.2 Клавиатуры (bot/keyboards)
- **base.py** — базовый класс для клавиатур (inline/reply)
- **main_keyboard.py** — основная клавиатура главного меню
- **inline_keyboard.py** — inline-клавиатуры для поиска и экспорта
- **pagination.py** — клавиатуры для пагинации
- **search.py** — клавиатуры для фильтров поиска
- **export.py** — клавиатуры для экспорта

### 3.3 Утилиты (bot/utils)
- **validation_utils.py** — валидация SRID, названий, координат, экспорта
- **format_utils.py** — форматирование сообщений, ошибок, координат
- **coord_utils.py** — парсинг, валидация, форматирование координат
- **log_utils.py** — расширенное логирование (требует замены MetricsCollector на MetricsManager)
- **keyboard_utils.py** — вспомогательные функции для клавиатур

### 3.4 Менеджеры и инфраструктура (enhanced/)
- **config_enhanced.py** — централизованная загрузка и валидация конфигов
- **db_manager_enhanced.py** — асинхронный менеджер работы с PostgreSQL
- **db_pool.py** — асинхронный пул соединений
- **metrics_manager.py** — сбор и хранение метрик
- **log_manager.py** — централизованное логирование
- **cache_manager.py** — асинхронный кэш с TTL
- **exceptions.py** — пользовательские исключения для инфраструктуры

### 3.5 Экспорт и шаблоны (enhanced/export/)
- **export_manager.py** — менеджер экспорта, выбор формата, валидация, метрики
- **exporters/** — реализации экспортеров (Civil3D, GMv20, GMv25)
- **templates/** — шаблоны для экспорта (JSON, XML)
- **config/export_config.json** — конфиг экспорта

### 3.6 Конфиги (config/, enhanced/config/)
- **db_config.json, enhanced_config.json, export_config.json** — основные конфиги
- **enhanced/config/database.json** — расширенный конфиг БД

### 3.7 Тесты (bot/tests/)
- **test_utils, test_handlers, test_exporters, test_examples** — покрытие утилит, обработчиков, экспортеров
- **conftest.py** — фикстуры для тестов

### 3.8 Документация и справка (spravka/)
- **Karta.md** — карта проекта, архитектура, приоритеты
- **Техническая документация.md** — (этот файл)
- **.env.example** — пример переменных окружения

### 3.9 Корневые файлы
- **main.py** — точка входа, запуск BotManager
- **requirements.txt, pyproject.toml, setup.py** — зависимости и сборка
- **README.md** — общее описание, инструкция по запуску

## 4. Взаимосвязи компонентов

- **BotManager** — инициализирует все менеджеры, обработчики, FSM, конфигурацию, запускает event loop Telegram-бота.
- **Обработчики** — отвечают за свою ветку логики, используют менеджеры (БД, кэш, метрики, логирование).
- **Менеджеры** — инфраструктурные сервисы (БД, пул, кэш, метрики, логирование), используются обработчиками и экспортом.
- **Экспорт** — ExportManager управляет экспортом, вызывает нужный экспортер, использует шаблоны.
- **Клавиатуры** — формируют inline и reply-клавиатуры для всех сценариев.
- **Утилиты** — валидация, парсинг, форматирование, логирование, вспомогательные функции.
- **Конфиги** — все параметры централизованно хранятся в JSON и .env, загружаются через EnhancedConfig.
- **Тесты** — покрывают обработчики, утилиты, экспортеры, менеджеры.

## 5. Устаревшие и неиспользуемые элементы

- **MetricsCollector** — устарел, заменён на MetricsManager. Требуется рефакторинг log_utils.py.
- **db_manager.py** — старый синхронный менеджер БД, заменён на db_manager_enhanced.py.
- **menu_handler.py (старый вариант)** — функционал распределён по новым обработчикам.
- **BotApplication** — удалён, запуск только через BotManager.
- **Некоторые тесты и примеры** — могут ссылаться на устаревшие классы/методы, требуют ревизии.

## 6. Рекомендации по развитию и оптимизации

### Критические задачи
- Доработать минимальный функционал экспортеров
- Обеспечить полную обработку ошибок на всех уровнях #выполнено
- Оптимизировать работу с PostgreSQL в Docker (healthcheck, SSL, env, volumes)
- Вынести все чувствительные данные в .env и переменные окружения #выполнено
- Провести ревизию и унификацию метрик (заменить MetricsCollector на MetricsManager) #выполнено

### Важные задачи
- Улучшить валидацию пользовательских данных
- Расширить покрытие тестами
- Улучшить документацию
- Реализовать мониторинг БД и метрик (Prometheus, Grafana)

### Желательные задачи
- Оптимизация производительности (кэширование, пакетная обработка, подготовленные запросы)
- Расширение функционала экспортеров
- Улучшение UI/UX
- Оптимизация работы с Docker
- Улучшение graceful shutdown, логирование завершения, обработка сигналов
- Расширение системы мониторинга и алертинга

## 7. Общая оценка системы

- Система построена по современным стандартам Python-разработки для асинхронных Telegram-ботов с PostgreSQL.
- Архитектура модульная, легко расширяемая, с чётким разделением ответственности.
- Большинство компонентов рабочие и интегрированы, но есть отдельные устаревшие элементы, требующие ревизии.
- Документация и карта проекта актуальны, но требуют регулярного обновления по мере развития системы.
- Рекомендации по развитию и оптимизации соответствуют лучшим практикам DevOps и Python-разработки.

## 6. Требования к переменным окружения и конфигурации

- Все параметры, подгружаемые из переменных окружения, должны приводиться к нужному типу (int, float, bool) в момент инициализации конфигурации.
- Для числовых и булевых параметров (например, DB_PORT, DB_MIN_CONNECTIONS, CACHE_ENABLED и др.) обязательно использовать явное приведение типов в коде (например, int(os.getenv('DB_PORT'))).
- В случае невозможности приведения типов или некорректного значения должна выбрасываться информативная ошибка конфигурации.
- Все dataclass-конфиги с обязательными параметрами должны инициализироваться только через from_dict после загрузки данных из файла.
- Перед инициализацией конфигов все значения вида ${ENV_VAR} должны быть заменены на значения из переменных окружения.
